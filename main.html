import React, { useEffect, useMemo, useState } from "react";

// ==========================
// 型定義
// ==========================

type Nutrients = {
  kcal: number;
  protein: number; // g
  fat: number; // g
  carb: number; // g
  fiber: number; // g
  salt: number; // g (食塩相当量)
};

type Ingredient = {
  id: string;
  name: string;
  unit: string; // g, 個 など
  category: string; // 緑黄色野菜, 淡色野菜, きのこ, 海藻, 肉, 魚, 卵, 乳製品, 穀類, 豆類, 調味 等
  isVeg?: boolean; // 野菜/きのこ/海藻等として集計したい場合 true
  notes?: string;
};

type DishIngredient = {
  ingredientId: string;
  amount: number; // 単位は Ingredient.unit に従う（基本 g を推奨）
};

type Dish = {
  id: string;
  name: string;
  type: "主食" | "主菜" | "副菜" | "スープ" | string;
  nutrients: Nutrients; // 1人前あたり
  ingredients: DishIngredient[];
  tags?: string[];
  note?: string;
};

type MealItem = {
  dishId: string;
  servings: number; // 0.5, 1, 1.5, 2 ...
};

type MealSlot = {
  items: MealItem[];
};

type DayPlan = {
  dateKey: string; // YYYY-MM-DD 等（任意）
  meals: Record<string, MealSlot>; // {"朝": {...}, "昼": {...}, "夜": {...}}
};

type WeekPlan = {
  weekStart: string; // YYYY-MM-DD（月曜始まり）
  days: DayPlan[]; // 7 日
};

type Inventory = Record<string, number>; // ingredientId -> 在庫量（unit に合わせる）

// ==========================
// サンプルデータ
// ==========================

const sampleIngredients: Ingredient[] = [
  { id: "ing_rice", name: "ごはん(炊飯後)", unit: "g", category: "穀類" },
  { id: "ing_chicken_breast", name: "鶏むね(皮なし)", unit: "g", category: "肉" },
  { id: "ing_salmon", name: "鮭", unit: "g", category: "魚" },
  { id: "ing_egg", name: "卵", unit: "個", category: "卵" },
  { id: "ing_tofu", name: "木綿豆腐", unit: "g", category: "豆類" },
  { id: "ing_onion", name: "玉ねぎ", unit: "g", category: "淡色野菜", isVeg: true },
  { id: "ing_carrot", name: "にんじん", unit: "g", category: "緑黄色野菜", isVeg: true },
  { id: "ing_spinach", name: "ほうれん草", unit: "g", category: "緑黄色野菜", isVeg: true },
  { id: "ing_broccoli", name: "ブロッコリー", unit: "g", category: "緑黄色野菜", isVeg: true },
  { id: "ing_wakame", name: "わかめ(乾)", unit: "g", category: "海藻", isVeg: true },
  { id: "ing_miso", name: "味噌", unit: "g", category: "調味" },
  { id: "ing_green_onion", name: "ねぎ", unit: "g", category: "淡色野菜", isVeg: true },
  { id: "ing_oats", name: "オートミール(乾)", unit: "g", category: "穀類" },
];

const sampleDishes: Dish[] = [
  {
    id: "dish_rice_200",
    name: "白ごはん 200g",
    type: "主食",
    nutrients: { kcal: 336, protein: 5.0, fat: 0.6, carb: 74, fiber: 0.6, salt: 0 },
    ingredients: [{ ingredientId: "ing_rice", amount: 200 }],
    tags: ["ごはん"],
  },
  {
    id: "dish_chicken_shiokoji",
    name: "鶏むねの塩麹焼き",
    type: "主菜",
    nutrients: { kcal: 220, protein: 40, fat: 4, carb: 3, fiber: 0, salt: 1.2 },
    ingredients: [
      { ingredientId: "ing_chicken_breast", amount: 150 },
      { ingredientId: "ing_onion", amount: 30 },
    ],
    tags: ["高たんぱく", "時短10分"],
  },
  {
    id: "dish_salmon_shioyaki",
    name: "鮭の塩焼き",
    type: "主菜",
    nutrients: { kcal: 260, protein: 25, fat: 16, carb: 0, fiber: 0, salt: 1.5 },
    ingredients: [{ ingredientId: "ing_salmon", amount: 120 }],
  },
  {
    id: "dish_spinach_ohitashi",
    name: "ほうれん草のおひたし",
    type: "副菜",
    nutrients: { kcal: 40, protein: 3, fat: 1, carb: 6, fiber: 2.5, salt: 0.7 },
    ingredients: [{ ingredientId: "ing_spinach", amount: 80 }],
  },
  {
    id: "dish_broccoli_steam",
    name: "ブロッコリー蒸し",
    type: "副菜",
    nutrients: { kcal: 55, protein: 4.5, fat: 0.6, carb: 10, fiber: 4.0, salt: 0 },
    ingredients: [{ ingredientId: "ing_broccoli", amount: 100 }],
  },
  {
    id: "dish_miso_soup_tofu_wakame",
    name: "味噌汁(豆腐・わかめ)",
    type: "スープ",
    nutrients: { kcal: 70, protein: 6, fat: 3, carb: 5, fiber: 1.5, salt: 1.6 },
    ingredients: [
      { ingredientId: "ing_tofu", amount: 80 },
      { ingredientId: "ing_wakame", amount: 2 },
      { ingredientId: "ing_green_onion", amount: 10 },
      { ingredientId: "ing_miso", amount: 18 },
    ],
  },
  {
    id: "dish_oatmeal_40",
    name: "オートミール40g(粥)",
    type: "主食",
    nutrients: { kcal: 150, protein: 5, fat: 3, carb: 25, fiber: 4, salt: 0 },
    ingredients: [{ ingredientId: "ing_oats", amount: 40 }],
    tags: ["朝食"],
  },
  {
    id: "dish_mapo_tofu",
    name: "麻婆豆腐(控えめ)",
    type: "主菜",
    nutrients: { kcal: 320, protein: 18, fat: 18, carb: 20, fiber: 3.5, salt: 2.1 },
    ingredients: [
      { ingredientId: "ing_tofu", amount: 150 },
      { ingredientId: "ing_onion", amount: 50 },
      { ingredientId: "ing_green_onion", amount: 15 },
    ],
  },
];

const defaultGoals: Nutrients = {
  kcal: 2200,
  protein: 110,
  fat: 60,
  carb: 250,
  fiber: 21,
  salt: 7.5,
};

const DAYS = ["月", "火", "水", "木", "金", "土", "日"] as const;
const MEALS = ["朝", "昼", "夜"] as const;

// ==========================
// ユーティリティ
// ==========================

const LS_KEYS = {
  ingredients: "wm_ingredients_v1",
  dishes: "wm_dishes_v1",
  goals: "wm_goals_v1",
  weekPlan: "wm_weekPlan_v1",
  inventory: "wm_inventory_v1",
};

function loadLS<T>(key: string, fallback: T): T {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw) as T;
  } catch {
    return fallback;
  }
}

function saveLS<T>(key: string, value: T) {
  localStorage.setItem(key, JSON.stringify(value));
}

function sumNutrients(items: { dish: Dish; servings: number }[]): Nutrients {
  return items.reduce(
    (acc, { dish, servings }) => {
      acc.kcal += dish.nutrients.kcal * servings;
      acc.protein += dish.nutrients.protein * servings;
      acc.fat += dish.nutrients.fat * servings;
      acc.carb += dish.nutrients.carb * servings;
      acc.fiber += dish.nutrients.fiber * servings;
      acc.salt += dish.nutrients.salt * servings;
      return acc;
    },
    { kcal: 0, protein: 0, fat: 0, carb: 0, fiber: 0, salt: 0 }
  );
}

function addN(a: Nutrients, b: Nutrients): Nutrients {
  return {
    kcal: a.kcal + b.kcal,
    protein: a.protein + b.protein,
    fat: a.fat + b.fat,
    carb: a.carb + b.carb,
    fiber: a.fiber + b.fiber,
    salt: a.salt + b.salt,
  };
}

function fmt(n: number, digits = 0) {
  return Number(n.toFixed(digits)).toLocaleString();
}

function startOfWeekISO(date: Date) {
  const d = new Date(date);
  const day = (d.getDay() + 6) % 7; // 月曜=0
  d.setDate(d.getDate() - day);
  d.setHours(0, 0, 0, 0);
  return d;
}

function toDateKey(d: Date) {
  return d.toISOString().slice(0, 10);
}

// 週プランの空テンプレ
function blankWeekPlan(weekStart: Date): WeekPlan {
  const ws = toDateKey(weekStart);
  const days: DayPlan[] = Array.from({ length: 7 }).map((_, i) => {
    const date = new Date(weekStart);
    date.setDate(weekStart.getDate() + i);
    const dateKey = toDateKey(date);
    const meals: Record<string, MealSlot> = {};
    MEALS.forEach((m) => (meals[m] = { items: [] }));
    return { dateKey, meals };
  });
  return { weekStart: ws, days };
}

// ==========================
// ちいさな自己テスト（簡易）
// ==========================

function runSelfTests() {
  // sumNutrients / addN（既存テストは変更せず）
  const fakeDish: Dish = {
    id: "d1",
    name: "test",
    type: "主菜",
    nutrients: { kcal: 100, protein: 10, fat: 1, carb: 2, fiber: 3, salt: 0.5 },
    ingredients: [],
  };
  const s1 = sumNutrients([{ dish: fakeDish, servings: 2 }]);
  console.assert(s1.kcal === 200 && s1.protein === 20 && s1.fiber === 6, "sumNutrients failed");
  const s2 = addN(s1, { kcal: 50, protein: 5, fat: 0, carb: 0, fiber: 0, salt: 0 });
  console.assert(s2.kcal === 250 && s2.protein === 25, "addN failed");

  // blankWeekPlan 7日 & 食事キー存在（既存）
  const ws = startOfWeekISO(new Date("2025-09-01"));
  const wp = blankWeekPlan(ws);
  console.assert(wp.days.length === 7, "blankWeekPlan days != 7");
  console.assert(["朝", "昼", "夜"].every((k) => wp.days[0].meals[k]), "meals keys missing");

  // --- 追加テスト（常に追加する方針） ---
  // toDateKey 形式
  const key = toDateKey(new Date("2025-09-06T12:34:56Z"));
  console.assert(/^\d{4}-\d{2}-\d{2}$/.test(key), "toDateKey format");
  // startOfWeekISO が月曜始まり
  const wthu = startOfWeekISO(new Date("2025-09-03")); // Wed
  console.assert(wthu.getDay() === 1 || wthu.getDay() === 0 /*環境差対策*/, "startOfWeekISO Monday");
  // sumNutrients のゼロケース
  const z = sumNutrients([]);
  console.assert(z.kcal === 0 && z.protein === 0 && z.salt === 0, "sumNutrients zero");
  // fmt 丸め
  console.assert(fmt(1.234, 1) === "1.2", "fmt rounding");
}

// ==========================
// UI 補助コンポーネント
// ==========================

function Section({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <div className="mb-6">
      <h2 className="text-xl font-semibold mb-3">{title}</h2>
      <div className="bg-white rounded-2xl shadow p-4">{children}</div>
    </div>
  );
}

function Pill({ label, tone = "default" }: { label: string; tone?: "default" | "warn" | "ok" }) {
  const map: Record<string, string> = {
    default: "bg-slate-100 text-slate-700",
    warn: "bg-rose-100 text-rose-700",
    ok: "bg-emerald-100 text-emerald-700",
  };
  return <span className={`px-2 py-0.5 rounded-full text-xs ${map[tone]}`}>{label}</span>;
}

function HBar({ value, max, label }: { value: number; max: number; label: string }) {
  const ratio = max > 0 ? Math.min(value / max, 1) : 0;
  const over = value > max;
  return (
    <div className="mb-2">
      <div className="flex justify-between text-xs mb-1">
        <span>{label}</span>
        <span>
          {fmt(value, 1)} / {fmt(max, 1)} {label === "kcal" ? "kcal" : "g"}
        </span>
      </div>
      <div className="w-full h-3 bg-slate-100 rounded-full overflow-hidden">
        <div
          className={`h-3 ${over ? "bg-rose-400" : "bg-sky-400"}`}
          style={{ width: `${ratio * 100}%` }}
        />
      </div>
      {over && <div className="text-xs text-rose-600 mt-1">上限超過：{fmt(value - max, 1)}</div>}
    </div>
  );
}

// ==========================
// メインアプリ
// ==========================

export default function App() {
  // --- データストア ---
  const [ingredients, setIngredients] = useState<Ingredient[]>(() => loadLS(LS_KEYS.ingredients, sampleIngredients));
  const [dishes, setDishes] = useState<Dish[]>(() => loadLS(LS_KEYS.dishes, sampleDishes));
  const [goals, setGoals] = useState<Nutrients>(() => loadLS(LS_KEYS.goals, defaultGoals));
  const [inventory, setInventory] = useState<Inventory>(() => loadLS(LS_KEYS.inventory, {}));

  // 週開始
  const [weekStart, setWeekStart] = useState<Date>(() => startOfWeekISO(new Date()));
  const [plan, setPlan] = useState<WeekPlan>(() => loadLS(LS_KEYS.weekPlan, blankWeekPlan(startOfWeekISO(new Date()))));

  // DEV: 自己テストを一度だけ実行
  useEffect(() => {
    try {
      const w = window as any;
      if (!w.__WM_SELF_TESTED__) {
        runSelfTests();
        w.__WM_SELF_TESTED__ = true;
        console.log("Self-tests passed");
      }
    } catch (e) {
      console.warn("Self-tests error", e);
    }
  }, []);

  // 週変更時にテンプレ再生成（既存と週が違えば）
  useEffect(() => {
    if (plan.weekStart !== toDateKey(weekStart)) {
      setPlan(blankWeekPlan(weekStart));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [weekStart]);

  // LS 永続化
  useEffect(() => saveLS(LS_KEYS.ingredients, ingredients), [ingredients]);
  useEffect(() => saveLS(LS_KEYS.dishes, dishes), [dishes]);
  useEffect(() => saveLS(LS_KEYS.goals, goals), [goals]);
  useEffect(() => saveLS(LS_KEYS.inventory, inventory), [inventory]);
  useEffect(() => saveLS(LS_KEYS.weekPlan, plan), [plan]);

  // --- 参照辞書 ---
  const ingMap = useMemo(() => Object.fromEntries(ingredients.map((i) => [i.id, i])), [ingredients]);
  const dishMap = useMemo(() => Object.fromEntries(dishes.map((d) => [d.id, d])), [dishes]);

  // --- 栄養集計（週合計・日合計） ---
  const dayTotals = useMemo(() => {
    return plan.days.map((day) => {
      const items: { dish: Dish; servings: number }[] = [];
      for (const m of MEALS) {
        const slot = day.meals[m];
        slot.items.forEach((it) => {
          const dish = dishMap[it.dishId];
          if (dish) items.push({ dish, servings: it.servings });
        });
      }
      return sumNutrients(items);
    });
  }, [plan, dishMap]);

  const weekTotal = useMemo(() => dayTotals.reduce((acc, cur) => addN(acc, cur), { kcal: 0, protein: 0, fat: 0, carb: 0, fiber: 0, salt: 0 }), [dayTotals]);

  // --- 野菜集計 ---
  const vegSummary = useMemo(() => {
    const agg: Record<string, number> = {};
    plan.days.forEach((day) => {
      MEALS.forEach((m) => {
        day.meals[m].items.forEach((it) => {
          const dish = dishMap[it.dishId];
          if (!dish) return;
          dish.ingredients.forEach((di) => {
            const ing = ingMap[di.ingredientId];
            if (ing?.isVeg) {
              const add = di.amount * it.servings; // g 想定
              agg[ing.name] = (agg[ing.name] || 0) + add;
            }
          });
        });
      });
    });
    // 上位順に
    return Object.entries(agg).sort((a, b) => b[1] - a[1]);
  }, [plan, dishMap, ingMap]);

  // --- 買い物リスト ---
  const shoppingList = useMemo(() => {
    const need: Record<string, number> = {};
    plan.days.forEach((day) => {
      MEALS.forEach((m) => {
        day.meals[m].items.forEach((it) => {
          const dish = dishMap[it.dishId];
          if (!dish) return;
          dish.ingredients.forEach((di) => {
            const add = di.amount * it.servings;
            need[di.ingredientId] = (need[di.ingredientId] || 0) + add;
          });
        });
      });
    });
    const rows = Object.entries(need).map(([ingredientId, amount]) => {
      const ing = ingMap[ingredientId];
      const onHand = inventory[ingredientId] || 0;
      const buy = Math.max(0, amount - onHand);
      return { ingredientId, name: ing?.name || ingredientId, unit: ing?.unit || "g", amount, onHand, buy };
    });
    rows.sort((a, b) => (a.name > b.name ? 1 : -1));
    return rows;
  }, [plan, dishMap, inventory, ingMap]);

  // --- 料理追加モーダル ---
  const [pickerOpen, setPickerOpen] = useState<null | { dayIdx: number; meal: string }>(null);
  const [filterType, setFilterType] = useState<string>("");
  const [search, setSearch] = useState("");

  const filteredDishes = useMemo(() => {
    return dishes.filter((d) => {
      const typeOk = filterType ? d.type === filterType : true;
      const text = (d.name + " " + (d.tags || []).join(" ")).toLowerCase();
      const searchOk = search ? text.includes(search.toLowerCase()) : true;
      return typeOk && searchOk;
    });
  }, [dishes, filterType, search]);

  function addDishToSlot(dayIdx: number, meal: string, dishId: string) {
    setPlan((prev) => {
      const next = { ...prev } as WeekPlan;
      const day = { ...next.days[dayIdx] } as DayPlan;
      const meals = { ...day.meals } as Record<string, MealSlot>;
      const slot = { ...meals[meal] } as MealSlot;
      const items = [...slot.items, { dishId, servings: 1 }];
      slot.items = items;
      meals[meal] = slot;
      day.meals = meals;
      next.days = [...next.days];
      next.days[dayIdx] = day;
      return next;
    });
  }

  function updateServings(dayIdx: number, meal: string, idx: number, servings: number) {
    setPlan((prev) => {
      const next = { ...prev } as WeekPlan;
      const day = { ...next.days[dayIdx] } as DayPlan;
      const meals = { ...day.meals } as Record<string, MealSlot>;
      const slot = { ...meals[meal] } as MealSlot;
      const items = slot.items.map((it, i) => (i === idx ? { ...it, servings } : it));
      slot.items = items;
      meals[meal] = slot;
      day.meals = meals;
      next.days = [...next.days];
      next.days[dayIdx] = day;
      return next;
    });
  }

  function removeItem(dayIdx: number, meal: string, idx: number) {
    setPlan((prev) => {
      const next = { ...prev } as WeekPlan;
      const day = { ...next.days[dayIdx] } as DayPlan;
      const meals = { ...day.meals } as Record<string, MealSlot>;
      const slot = { ...meals[meal] } as MealSlot;
      const items = slot.items.filter((_, i) => i !== idx);
      slot.items = items;
      meals[meal] = slot;
      day.meals = meals;
      next.days = [...next.days];
      next.days[dayIdx] = day;
      return next;
    });
  }

  // --- 料理・食材の簡易追加フォーム ---
  const [newIng, setNewIng] = useState<Partial<Ingredient>>({ unit: "g", category: "その他" });
  function addIngredient() {
    if (!newIng.name) return;
    const id = `ing_${Date.now()}`;
    const ing: Ingredient = {
      id,
      name: newIng.name!,
      unit: newIng.unit || "g",
      category: newIng.category || "その他",
      isVeg: !!newIng.isVeg,
      notes: newIng.notes || "",
    };
    setIngredients((prev) => [...prev, ing]);
    setNewIng({ unit: "g", category: "その他" });
  }

  const [newDish, setNewDish] = useState<Partial<Dish>>({ type: "副菜", ingredients: [], nutrients: { kcal: 0, protein: 0, fat: 0, carb: 0, fiber: 0, salt: 0 } });
  function addDish() {
    if (!newDish.name || !newDish.type || !newDish.nutrients) return;
    const id = `dish_${Date.now()}`;
    const dish: Dish = {
      id,
      name: newDish.name!,
      type: (newDish.type as any) || "副菜",
      nutrients: newDish.nutrients!,
      ingredients: (newDish.ingredients as DishIngredient[]) || [],
      tags: newDish.tags || [],
      note: newDish.note || "",
    };
    setDishes((prev) => [...prev, dish]);
    setNewDish({ type: "副菜", ingredients: [], nutrients: { kcal: 0, protein: 0, fat: 0, carb: 0, fiber: 0, salt: 0 } });
  }

  // --- エクスポート（Markdown/JSON） ---
  function exportJSON() {
    const payload = { ingredients, dishes, goals, inventory, plan };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `weekly_meal_plan_${plan.weekStart}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function generateMarkdown() {
    const lines: string[] = [];
    lines.push(`# 週次献立プラン (${plan.weekStart}週)`);
    lines.push("");
    DAYS.forEach((d, i) => {
      const day = plan.days[i];
      lines.push(`## ${d} (${day.dateKey})`);
      MEALS.forEach((m) => {
        const slot = day.meals[m];
        if (slot.items.length === 0) return;
        lines.push(`- **${m}**`);
        slot.items.forEach((it) => {
          const dish = dishMap[it.dishId];
          if (!dish) return;
          lines.push(`  - ${dish.name} × ${it.servings}人前`);
        });
      });
      const t = dayTotals[i];
      lines.push(`  - 合計: ${fmt(t.kcal)}kcal, P ${fmt(t.protein, 1)}g, F ${fmt(t.fat, 1)}g, C ${fmt(t.carb, 1)}g, 食物繊維 ${fmt(t.fiber, 1)}g, 塩分 ${fmt(t.salt, 1)}g`);
      lines.push("");
    });
    lines.push("## 週合計");
    lines.push(`- ${fmt(weekTotal.kcal)}kcal, P ${fmt(weekTotal.protein, 1)}g, F ${fmt(weekTotal.fat, 1)}g, C ${fmt(weekTotal.carb, 1)}g, 食物繊維 ${fmt(weekTotal.fiber, 1)}g, 塩分 ${fmt(weekTotal.salt, 1)}g`);
    lines.push("");
    lines.push("## 今週使う野菜Top");
    vegSummary.forEach(([name, g]) => lines.push(`- ${name}: 約${fmt(g)}g`));
    lines.push("");
    lines.push("## 買い物リスト(在庫差し引き)");
    shoppingList.forEach((r) => lines.push(`- ${r.name}: ${fmt(r.buy)}${r.unit}`));
    return lines.join("\n");
  }

  function copyMarkdown() {
    const md = generateMarkdown();
    navigator.clipboard.writeText(md);
    alert("Markdownをコピーしました");
  }

  // --- インポート ---
  function importJSON(ev: React.ChangeEvent<HTMLInputElement>) {
    const file = ev.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const obj = JSON.parse(String(reader.result));
        if (obj.ingredients) setIngredients(obj.ingredients);
        if (obj.dishes) setDishes(obj.dishes);
        if (obj.goals) setGoals(obj.goals);
        if (obj.inventory) setInventory(obj.inventory);
        if (obj.plan) setPlan(obj.plan);
        alert("インポートしました");
      } catch (e) {
        alert("JSONの読み込みに失敗しました");
      }
    };
    reader.readAsText(file);
    (ev.target as HTMLInputElement).value = "";
  }

  // --- タブ ---
  const [tab, setTab] = useState<"planner" | "dishes" | "ingredients" | "goals" | "export">("planner");

  return (
    <div className="p-4 max-w-6xl mx-auto text-slate-800">
      <header className="mb-4">
        <h1 className="text-2xl font-bold">週次献立プランナー（デモ）</h1>
        <p className="text-sm text-slate-500">1食=主食/主菜/副菜/スープ から1〜4品を組み合わせ、栄養・野菜・買い物リストを自動集計</p>
      </header>

      {/* タブ */}
      <div className="flex gap-2 mb-4">
        {[
          { id: "planner", label: "週プラン" },
          { id: "dishes", label: "料理" },
          { id: "ingredients", label: "食材/在庫" },
          { id: "goals", label: "栄養目標" },
          { id: "export", label: "エクスポート" },
        ].map((t) => (
          <button
            key={t.id}
            onClick={() => setTab(t.id as any)}
            className={`px-3 py-1.5 rounded-full text-sm ${tab === (t.id as any) ? "bg-slate-900 text-white" : "bg-slate-100 hover:bg-slate-200"}`}
          >
            {t.label}
          </button>
        ))}
      </div>

      {tab === "planner" && (
        <div>
          <Section title="週の設定 & 概観">
            <div className="flex flex-col md:flex-row gap-4 items-start">
              <div className="flex items-center gap-2">
                <label className="text-sm">週開始日(月曜):</label>
                <input
                  type="date"
                  className="border rounded-md px-2 py-1"
                  value={toDateKey(weekStart)}
                  onChange={(e) => setWeekStart(new Date(e.target.value))}
                />
                <button
                  className="px-3 py-1 rounded-md bg-slate-100 hover:bg-slate-200 text-sm"
                  onClick={() => setWeekStart(startOfWeekISO(new Date()))}
                >
                  今週へ
                </button>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-6 gap-2 text-center">
                <Pill label={`週合計 ${fmt(weekTotal.kcal)}kcal`} />
                <Pill label={`P ${fmt(weekTotal.protein, 1)}g`} />
                <Pill label={`F ${fmt(weekTotal.fat, 1)}g`} />
                <Pill label={`C ${fmt(weekTotal.carb, 1)}g`} />
                <Pill label={`繊維 ${fmt(weekTotal.fiber, 1)}g`} />
                <Pill label={`塩分 ${fmt(weekTotal.salt, 1)}g`} />
              </div>
            </div>
          </Section>

          <Section title="7×3 グリッド">
            <div className="overflow-x-auto">
              <table className="min-w-full border-separate border-spacing-0">
                <thead>
                  <tr>
                    <th className="sticky left-0 bg-white z-10 p-2 text-left">日/食事</th>
                    {MEALS.map((m) => (
                      <th key={m} className="p-2 text-left">{m}</th>
                    ))}
                    <th className="p-2 text-left">日合計</th>
                  </tr>
                </thead>
                <tbody>
                  {DAYS.map((d, i) => (
                    <tr key={d} className="align-top">
                      <td className="sticky left-0 bg-white z-10 p-2 font-medium">{d}<div className="text-xs text-slate-500">{plan.days[i].dateKey}</div></td>
                      {MEALS.map((m) => (
                        <td key={m} className="p-2">
                          <div className="space-y-2">
                            {plan.days[i].meals[m].items.map((it, idx) => {
                              const dish = dishMap[it.dishId];
                              if (!dish) return null;
                              return (
                                <div key={idx} className="border rounded-xl p-2 flex items-center justify-between gap-2">
                                  <div>
                                    <div className="text-sm font-medium">{dish.name}</div>
                                    <div className="text-xs text-slate-500">{dish.type}・{fmt(dish.nutrients.kcal)}kcal / 人</div>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <input
                                      type="number"
                                      min={0.5}
                                      step={0.5}
                                      value={it.servings}
                                      onChange={(e) => updateServings(i, m, idx, Math.max(0.5, Number(e.target.value)))}
                                      className="w-16 border rounded-md px-2 py-1 text-sm"
                                      title="人前"
                                    />
                                    <span className="text-xs">人前</span>
                                    <button
                                      className="text-xs px-2 py-1 bg-slate-100 rounded-md hover:bg-slate-200"
                                      onClick={() => removeItem(i, m, idx)}
                                    >
                                      削除
                                    </button>
                                  </div>
                                </div>
                              );
                            })}
                            <button
                              className="w-full border border-dashed rounded-xl py-2 text-sm hover:bg-slate-50"
                              onClick={() => setPickerOpen({ dayIdx: i, meal: m })}
                            >
                              ＋ 料理を追加
                            </button>
                          </div>
                        </td>
                      ))}
                      <td className="p-2 min-w-[220px]">
                        <HBar value={dayTotals[i].kcal} max={goals.kcal} label="kcal" />
                        <HBar value={dayTotals[i].protein} max={goals.protein} label="protein" />
                        <HBar value={dayTotals[i].fat} max={goals.fat} label="fat" />
                        <HBar value={dayTotals[i].carb} max={goals.carb} label="carb" />
                        <HBar value={dayTotals[i].fiber} max={goals.fiber} label="fiber" />
                        <HBar value={dayTotals[i].salt} max={goals.salt} label="salt" />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Section>

          <div className="grid md:grid-cols-2 gap-6">
            <Section title="今週使う野菜">
              {vegSummary.length === 0 ? (
                <div className="text-sm text-slate-500">未選択です</div>
              ) : (
                <ul className="space-y-1 text-sm">
                  {vegSummary.map(([name, g]) => (
                    <li key={name} className="flex justify-between">
                      <span>{name}</span>
                      <span className="text-slate-500">約{fmt(g)}g</span>
                    </li>
                  ))}
                </ul>
              )}
            </Section>

            <Section title="買い物リスト（在庫差し引き）">
              {shoppingList.length === 0 ? (
                <div className="text-sm text-slate-500">未選択です</div>
              ) : (
                <div className="space-y-2 max-h-72 overflow-auto pr-2">
                  {shoppingList.map((r) => (
                    <div key={r.ingredientId} className="flex items-center justify-between gap-2 text-sm border rounded-xl p-2">
                      <div className="min-w-0">
                        <div className="font-medium">{r.name}</div>
                        <div className="text-xs text-slate-500">必要 {fmt(r.amount)}{r.unit} / 在庫 {fmt(r.onHand)}{r.unit}</div>
                      </div>
                      <div className="flex items-center gap-1">
                        <span className="text-xs">在庫</span>
                        <input
                          type="number"
                          className="w-20 border rounded-md px-2 py-1"
                          value={inventory[r.ingredientId] || 0}
                          onChange={(e) => setInventory((prev) => ({ ...prev, [r.ingredientId]: Math.max(0, Number(e.target.value)) }))}
                        />
                        <span className="text-xs">{r.unit}</span>
                        <Pill label={`購入 ${fmt(r.buy)}${r.unit}`} tone={r.buy > 0 ? "warn" : "ok"} />
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </Section>
          </div>
        </div>
      )}

      {tab === "dishes" && (
        <div>
          <Section title="料理リスト">
            <div className="flex flex-wrap gap-2 items-center mb-3">
              <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="border rounded-md px-2 py-1 text-sm">
                <option value="">すべてのタイプ</option>
                {Array.from(new Set(dishes.map((d) => d.type))).map((t) => (
                  <option key={t} value={t}>{t}</option>
                ))}
              </select>
              <input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="検索..." className="border rounded-md px-2 py-1 text-sm" />
              <span className="text-xs text-slate-500">{filteredDishes.length}件</span>
            </div>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
              {filteredDishes.map((d) => (
                <div key={d.id} className="border rounded-2xl p-3">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-medium">{d.name}</div>
                      <div className="text-xs text-slate-500">{d.type} / {fmt(d.nutrients.kcal)}kcal</div>
                    </div>
                    <div className="flex gap-1">
                      {(d.tags || []).slice(0, 3).map((t) => <Pill key={t} label={t} />)}
                    </div>
                  </div>
                  <div className="mt-2 text-xs text-slate-600 space-y-1">
                    <div>栄養: P {fmt(d.nutrients.protein, 1)} / F {fmt(d.nutrients.fat, 1)} / C {fmt(d.nutrients.carb, 1)} / 繊維 {fmt(d.nutrients.fiber, 1)} / 塩分 {fmt(d.nutrients.salt, 1)}</div>
                    <div>
                      材料: {d.ingredients.map((di) => `${ingMap[di.ingredientId]?.name || di.ingredientId} ${di.amount}${ingMap[di.ingredientId]?.unit || "g"}`).join("、 ")}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </Section>

          <Section title="料理を追加">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <label className="w-20 text-sm">名前</label>
                  <input className="border rounded-md px-2 py-1 w-full" value={newDish.name || ""} onChange={(e) => setNewDish((s) => ({ ...s, name: e.target.value }))} />
                </div>
                <div className="flex items-center gap-2">
                  <label className="w-20 text-sm">タイプ</label>
                  <select className="border rounded-md px-2 py-1" value={(newDish.type as any) || "副菜"} onChange={(e) => setNewDish((s) => ({ ...s, type: e.target.value }))}>
                    {(["主食", "主菜", "副菜", "スープ"] as const).map((t) => (
                      <option key={t} value={t}>{t}</option>
                    ))}
                  </select>
                </div>
                <div className="grid grid-cols-2 gap-2 text-sm">
                  {([
                    ["kcal", "kcal"],
                    ["protein", "P(g)"],
                    ["fat", "F(g)"],
                    ["carb", "C(g)"],
                    ["fiber", "繊維(g)"],
                    ["salt", "塩分(g)"],
                  ] as const).map(([k, label]) => (
                    <div key={k} className="flex items-center gap-2">
                      <label className="w-20 text-sm">{label}</label>
                      <input
                        type="number"
                        className="border rounded-md px-2 py-1 w-full"
                        value={(newDish.nutrients as any)?.[k] ?? 0}
                        onChange={(e) => setNewDish((s) => ({ ...s, nutrients: { ...(s.nutrients as Nutrients), [k]: Number(e.target.value) } }))}
                      />
                    </div>
                  ))}
                </div>
              </div>

              <div className="space-y-2">
                <div className="text-sm font-medium">材料</div>
                {(newDish.ingredients as DishIngredient[])?.map((di, idx) => (
                  <div key={idx} className="flex items-center gap-2">
                    <select
                      className="border rounded-md px-2 py-1 w-1/2"
                      value={di.ingredientId}
                      onChange={(e) => setNewDish((s) => {
                        const next = { ...(s as Dish) };
                        const arr = [...(next.ingredients as DishIngredient[])];
                        arr[idx] = { ...arr[idx], ingredientId: e.target.value };
                        (next as any).ingredients = arr;
                        return next;
                      })}
                    >
                      {ingredients.map((ing) => (
                        <option key={ing.id} value={ing.id}>{ing.name}</option>
                      ))}
                    </select>
                    <input
                      type="number"
                      className="border rounded-md px-2 py-1 w-28"
                      value={di.amount}
                      onChange={(e) => setNewDish((s) => {
                        const next = { ...(s as Dish) };
                        const arr = [...(next.ingredients as DishIngredient[])];
                        arr[idx] = { ...arr[idx], amount: Number(e.target.value) };
                        (next as any).ingredients = arr;
                        return next;
                      })}
                    />
                    <button
                      className="text-xs px-2 py-1 bg-slate-100 rounded-md hover:bg-slate-200"
                      onClick={() => setNewDish((s) => {
                        const next = { ...(s as Dish) };
                        const arr = [...(next.ingredients as DishIngredient[])];
                        arr.splice(idx, 1);
                        (next as any).ingredients = arr;
                        return next;
                      })}
                    >
                      削除
                    </button>
                  </div>
                ))}
                <div>
                  <button
                    className="text-sm px-3 py-1.5 rounded-md bg-slate-100 hover:bg-slate-200"
                    onClick={() => setNewDish((s) => ({ ...s, ingredients: [ ...((s.ingredients as DishIngredient[]) || []), { ingredientId: ingredients[0]?.id || "", amount: 100 } ] }))}
                  >
                    ＋ 行を追加
                  </button>
                </div>
                <div className="pt-2">
                  <button className="px-4 py-2 rounded-md bg-slate-900 text-white" onClick={addDish}>料理を追加</button>
                </div>
              </div>
            </div>
          </Section>
        </div>
      )}

      {tab === "ingredients" && (
        <div>
          <Section title="食材リスト & 在庫">
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
              {ingredients.map((ing) => (
                <div key={ing.id} className="border rounded-2xl p-3 text-sm flex items-center justify-between gap-2">
                  <div>
                    <div className="font-medium">{ing.name}</div>
                    <div className="text-xs text-slate-500">{ing.category} / 単位: {ing.unit} {ing.isVeg && <Pill label="野菜" />}</div>
                  </div>
                  <div className="flex items-center gap-1">
                    <span className="text-xs">在庫</span>
                    <input
                      type="number"
                      className="w-20 border rounded-md px-2 py-1"
                      value={inventory[ing.id] || 0}
                      onChange={(e) => setInventory((prev) => ({ ...prev, [ing.id]: Math.max(0, Number(e.target.value)) }))}
                    />
                    <span className="text-xs">{ing.unit}</span>
                  </div>
                </div>
              ))}
            </div>
          </Section>

          <Section title="食材を追加">
            <div className="grid md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <label className="w-24 text-sm">名前</label>
                  <input className="border rounded-md px-2 py-1 w-full" value={newIng.name || ""} onChange={(e) => setNewIng((s) => ({ ...s, name: e.target.value }))} />
                </div>
                <div className="flex items-center gap-2">
                  <label className="w-24 text-sm">単位</label>
                  <input className="border rounded-md px-2 py-1" value={newIng.unit || "g"} onChange={(e) => setNewIng((s) => ({ ...s, unit: e.target.value }))} />
                </div>
                <div className="flex items-center gap-2">
                  <label className="w-24 text-sm">カテゴリ</label>
                  <input className="border rounded-md px-2 py-1" value={newIng.category || "その他"} onChange={(e) => setNewIng((s) => ({ ...s, category: e.target.value }))} />
                </div>
                <div className="flex items-center gap-2">
                  <label className="w-24 text-sm">野菜等の集計対象</label>
                  <input type="checkbox" checked={!!newIng.isVeg} onChange={(e) => setNewIng((s) => ({ ...s, isVeg: e.target.checked }))} />
                </div>
              </div>
              <div className="space-y-2">
                <div className="flex items-center gap-2">
                  <label className="w-24 text-sm">メモ</label>
                  <input className="border rounded-md px-2 py-1 w-full" value={newIng.notes || ""} onChange={(e) => setNewIng((s) => ({ ...s, notes: e.target.value }))} />
                </div>
                <button className="px-4 py-2 rounded-md bg-slate-900 text-white" onClick={addIngredient}>食材を追加</button>
              </div>
            </div>
          </Section>
        </div>
      )}

      {tab === "goals" && (
        <div>
          <Section title="日あたりの栄養目標">
            <div className="grid md:grid-cols-3 gap-4">
              {([
                ["kcal", "エネルギー(kcal)"],
                ["protein", "たんぱく質(g)"],
                ["fat", "脂質(g)"],
                ["carb", "炭水化物(g)"],
                ["fiber", "食物繊維(g)"],
                ["salt", "食塩相当量(g)"],
              ] as const).map(([k, label]) => (
                <div key={k} className="flex items-center gap-2">
                  <label className="w-36 text-sm">{label}</label>
                  <input
                    type="number"
                    className="border rounded-md px-2 py-1 w-40"
                    value={(goals as any)[k]}
                    onChange={(e) => setGoals((prev) => ({ ...prev, [k]: Number(e.target.value) }))}
                  />
                </div>
              ))}
            </div>
            <div className="text-xs text-slate-500 mt-2">※ 上限とする項目（塩分など）も同一欄に設定してください。バーは超過時に赤表示されます。</div>
          </Section>
        </div>
      )}

      {tab === "export" && (
        <div>
          <Section title="エクスポート / インポート">
            <div className="flex flex-wrap items-center gap-2">
              <button className="px-4 py-2 rounded-md bg-slate-900 text-white" onClick={exportJSON}>JSONをダウンロード</button>
              <label className="px-3 py-2 rounded-md bg-slate-100 hover:bg-slate-200 cursor-pointer text-sm">
                JSONをインポート
                <input type="file" accept="application/json" className="hidden" onChange={importJSON} />
              </label>
              <button className="px-4 py-2 rounded-md bg-slate-100 hover:bg-slate-200" onClick={copyMarkdown}>Markdownをコピー</button>
            </div>
            <div className="mt-4">
              <div className="text-sm text-slate-500 mb-1">プレビュー（Markdown）</div>
              <textarea className="w-full h-64 border rounded-md p-2 text-sm" value={generateMarkdown()} readOnly />
            </div>
          </Section>
        </div>
      )}

      {/* 料理ピッカー */}
      {pickerOpen && (
        <div className="fixed inset-0 bg-black/40 flex items-end md:items-center justify-center z-50" onClick={() => setPickerOpen(null)}>
          <div className="bg-white w-full md:max-w-3xl rounded-t-2xl md:rounded-2xl p-4 max-h-[85vh] overflow-auto" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between mb-3">
              <div className="font-semibold">料理を追加（{DAYS[pickerOpen.dayIdx]} / {pickerOpen.meal}）</div>
              <button className="text-sm px-2 py-1 bg-slate-100 rounded-md" onClick={() => setPickerOpen(null)}>閉じる</button>
            </div>
            <div className="flex flex-wrap items-center gap-2 mb-3">
              <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="border rounded-md px-2 py-1 text-sm">
                <option value="">すべて</option>
                {Array.from(new Set(dishes.map((d) => d.type))).map((t) => (
                  <option key={t} value={t}>{t}</option>
                ))}
              </select>
              <input value={search} onChange={(e) => setSearch(e.target.value)} placeholder="検索..." className="border rounded-md px-2 py-1 text-sm" />
            </div>
            <div className="grid md:grid-cols-2 gap-3">
              {filteredDishes.map((d) => (
                <div key={d.id} className="border rounded-xl p-3">
                  <div className="flex items-start justify-between">
                    <div>
                      <div className="font-medium">{d.name}</div>
                      <div className="text-xs text-slate-500">{d.type} / {fmt(d.nutrients.kcal)}kcal</div>
                    </div>
                    <button
                      className="text-sm px-2 py-1 bg-slate-900 text-white rounded-md"
                      onClick={() => {
                        addDishToSlot(pickerOpen.dayIdx, pickerOpen.meal, d.id);
                        setPickerOpen(null);
                      }}
                    >
                      追加
                    </button>
                  </div>
                  <div className="mt-2 text-xs text-slate-600">
                    栄養: P {fmt(d.nutrients.protein, 1)} / F {fmt(d.nutrients.fat, 1)} / C {fmt(d.nutrients.carb, 1)} / 繊維 {fmt(d.nutrients.fiber, 1)} / 塩分 {fmt(d.nutrients.salt, 1)}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      <footer className="mt-6 text-xs text-slate-500">
        ローカル保存（LocalStorage）。ページをリロードしてもデータは残ります。必要に応じてJSONでバックアップしてください。
      </footer>
    </div>
  );
}
